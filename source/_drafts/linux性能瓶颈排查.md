---
title: linux性能瓶颈排查
comments: true
categories: 笔记
tags:
  - linux
abbrlink: 35fb180b
date: 2021-08-26 10:17:25
---

#### 前言

服务器出问题 每次排查都现查 抽个时间 做个总结 方便自己速查     
服务器问题 总的来说 就几个方面 cpu 、内存、io、网络、硬盘、inode、描述符等问题

#### 示例

> 参考文档:
> https://www.cnblogs.com/zhengah/p/4616708.html

##### top 查看系统总负载情况 cpu 内存、进程等

```shell
top  
```

%us：表示用户空间程序的cpu使用率（没有通过nice调度） %sy：表示系统空间的cpu使用率，主要是内核程序。 %ni：表示用户空间且通过nice调度过的程序的cpu使用率。 %id：空闲cpu %wa：cpu运行时在等待io的时间
%hi：cpu处理硬中断的数量 %si：cpu处理软中断的数量 %st：被虚拟机偷走的cpu

##### vmstat  查看系统进程、内存、io 系统负载、cpu等情况 

```shell
# 第一个参数为间隔 第二个为采样数 
vmstat 1 5
```

r 表示运行队列(就是说多少个进程真的分配到CPU)，我测试的服务器目前CPU比较空闲，没什么程序在跑，当这个值超过了CPU数目，就会出现CPU瓶颈
了。这个也和top的负载有关系，一般负载超过了3就比较高，超过了5就高，超过了10就不正常了，服务器的状态很危险。top的负载类似每秒的运行队 列。如果运行队列过大，表示你的CPU很繁忙，一般会造成CPU使用率很高。 b
表示阻塞的进程,这个不多说，进程阻塞，大家懂的。 swpd 虚拟内存已使用的大小，如果大于0，表示你的机器物理内存不足了，如果不是程序内存泄露的原因，那么你该升级内存了或者把耗内存的任务迁移到其他机器。 free
空闲的物理内存的大小，我的机器内存总共8G，剩余3415M。 buff Linux/Unix系统是用来存储，目录里面有什么内容，权限等的缓存，我本机大概占用300多M cache
cache直接用来记忆我们打开的文件,给文件做缓冲，我本机大概占用300多M(这里是Linux/Unix的聪明之处，把空闲的物理内存的一部分拿来做文件和目录的缓存，是为了提高
程序执行的性能，当程序使用内存时，buffer/cached会很快地被使用。)
si 每秒从磁盘读入虚拟内存的大小，如果这个值大于0，表示物理内存不够用或者内存泄露了，要查找耗内存进程解决掉。我的机器内存充裕，一切正常。 so 每秒虚拟内存写入磁盘的大小，如果这个值大于0，同上。 bi
块设备每秒接收的块数量，这里的块设备是指系统上所有的磁盘和其他块设备，默认块大小是1024byte，我本机上没什么IO操作，所以一直是0，但是我曾在处理拷贝大量数据(2-3T)
的机器上看过可以达到140000/s，磁盘写入速度差不多140M每秒 bo 块设备每秒发送的块数量，例如我们读取文件，bo就要大于0。bi和bo一般都要接近0，不然就是IO过于频繁，需要调整。 in 每秒CPU的中断次数，包括时间中断 cs
每秒上下文切换次数，例如我们调用系统函数，就要进行上下文切换，线程的切换，也要进程上下文切换，这个值要越小越好，太大了，要考虑调低线程或者进程的
数目,例如在apache和nginx这种web服务器中，我们一般做性能测试时会进行几千并发甚至几万并发的测试，选择web服务器的进程可以由进程或
者线程的峰值一直下调，压测，直到cs到一个比较小的值，这个进程和线程数就是比较合适的值了。系统调用也是，每次调用系统函数，我们的代码就会进入内核
空间，导致上下文切换，这个是很耗资源，也要尽量避免频繁调用系统函数。上下文切换次数过多表示你的CPU大部分浪费在上下文切换，导致CPU干正经事的 时间少了，CPU没有充分利用，是不可取的。 us
用户CPU时间，我曾经在一个做加密解密很频繁的服务器上，可以看到us接近100,r运行队列达到80(机器在做压力测试，性能表现不佳)。 sy 系统CPU时间，如果太高，表示系统调用时间长，例如是IO操作频繁。 id 空闲
CPU时间，一般来说，id + us + sy = 100,一般我认为id是空闲CPU使用率，us是用户CPU使用率，sy是系统CPU使用率。 wt 等待IO CPU时间。

##### iostat 查看系统io情况 cpu和各个硬件io

> https://cloud.tencent.com/developer/article/1590085
> https://blog.csdn.net/stevenchen1989/article/details/104745034/

* iostat %user：CPU 处在用户模式下的时间百分比 %nice：CPU 处在带 NICE 值的用户模式下的时间百分比，即改变过优先级的进程的占用 CPU 的百分比 %system：CPU 处在内核模式下的时间百分比
  %iowait：CPU 等待输入输出完成时间的百分比 %steal：管理程序维护另一个虚拟处理器时，虚拟 CPU 的无意识等待时间百分比 %idle：CPU 空闲时间百分比

  Device：/dev 目录下的磁盘（或分区）名称 tps：该设备每秒的传输次数。一次传输即一次 I/O 请求，多个逻辑请求可能会被合并为一次 I/O 请求。一次传输请求的大小是未知的 Blk_read/s (kB_read/s,
  MB_read/s)：每秒读取的数据大小。每个块等同于扇区，大小为 512B Blk_wrtn/s (kB_wrtn/s, MB_wrtn/s)：每秒写入的数据大小 Blk_read (kB_read, MB_read)
  ：读取数据的总大小 Blk_wrtn (kB_wrtn, MB_wrtn)：写入数据的总大小

* iostat -dx Device：/dev 目录下的磁盘（或分区）名称 rrqm/s：每秒合并到设备队列中的读取请求数 wrqm/s：每秒合并到设备队列中的写请求数 r/s：设备每秒完成的读请求数 w/s：设备每秒完成的写请求数
  rsec/s (rkB/s, rMB/s)：每秒读取的数据大小。每扇区大小为 512 字节 wsec/s (wkB/s, wMB/s)：每秒写入的数据大小 avgrq-sz：平均每次设备 I/O 操作的数据大小 avgqu-sz：
  I/O 请求队列平均长度 await：每次 I/O 平均耗时 （单位毫秒）。包括在请求队列中的等待时间和真正 I/O 时间 r_await：每个读操作平均耗时（单位毫秒）。包括在请求队列中的等待时间和真正读取时间
  w_await：每个写操作平均耗时（单位毫秒）。包括在请求队列中的等待时间和真正写入时间 svctm：平均每次设备 I/O 操作的服务时间（单位毫秒）。警告！不要再信任此字段，此字段将在将来的 sysstat 版本中删除
  %util：在统计时间内所有处理IO时间，除以总共统计时间。例如，如果统计间隔 1s，该 设备有 0.8s 在处理 I/O，而 0.2s 闲置，那么该设备的 %util = 0.8/1 = 80%，所以该参数暗示了设备的繁忙程度

##### netstat 查看网络情况 

##### lspci  查看当前连接到pci上的设备情况 

##### ip/ipconfig 查看ip相关情况

##### free 查看内存情况

##### du / df 查看磁盘情况 

##### dig 查看域名解析情况  

##### fd信息 查看文件描述符情况 

https://blog.csdn.net/genzld/article/details/86564821

##### stat 查看inode情况



##### lsof 列举文件

##### ps 查看进程信息 








