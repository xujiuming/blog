---
title: 限流方案笔记 
comments: true 
date: 2022-02-08 09:50:10 
categories: 实战 
tags:
    - 限流
    - guava
    - redis
---

#### 前言

限流常用的算法 都有过记录了 但是实际开发中 使用限流的方案 还是很多的 这里做个简单的记录 方便后续速查

#### 示例

> 所有示例 基于spring mvc的拦截器(Interceptor)来实现，可以使用其他方式实现如filter,aop 等方式实现      
> 只对请求进行限制 只是个例子 可以扩展其他方面 例如某个函数访问频率控制(aop+限流)    

##### guava的RateLimiter 

> 基于guava实现的单机限流  适合单节点内限流   

```java
package com.ming.base.mvc.interceptor;

import com.google.common.util.concurrent.RateLimiter;
import com.ming.base.config.UrlConfig;
import com.ming.core.CodeEnum;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Component;
import org.springframework.web.servlet.HandlerInterceptor;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

@Component
@Slf4j
public class RequestLimitInterceptor implements HandlerInterceptor {
    /**
     * 使用guava的令牌桶限流
     * 暂定 1s/10 不做预热限流
     *
     * @author ming
     * @date 2021-12-19 21:51:18
     */
    private RateLimiter rateLimiter = RateLimiter.create(1000);

    @Override
    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception {
        if (!rateLimiter.tryAcquire()) {
            log.warn("触发限流!,url:{},method:{}", request.getRequestURI(), request.getMethod());
            UrlConfig.throwCodeException(response, CodeEnum.REQUEST_ILLEGAL, "触发限流!");
            return false;
        }
        return true;
    }
}
```

##### redis